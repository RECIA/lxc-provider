#!/bin/bash

. /lxc/etc/lxc-provider.conf
. ${lxc_GLOBAL_FUNCTIONS}

localusage() {
	myname=$(basename $0)
	echo "Usage:"
	echo "${myname} create [options]    : creates cache"
	echo "${myname} list                : lists available cached distrib"
	echo "${myname} destroy [options]   : deletes cached distrib"
	echo "${myname} debuginfo [options] : shows env vars used by scripts"
	echo "options:"
	echo -e "(default)\t-d ${lxc_GLOBAL_DEFAULT_DISTRIB}"
	echo -e "\t\t\tDistribution (needs conf file in ${lxc_GLOBAL_ETC_HOME}/distrib/"
	echo -e "(default)\t-a ${lxc_GLOBAL_DEFAULT_ARCH}"
	echo -e "\t\t\tArchitecture (amd64, i386, etc...)"
	echo -e "(default)\t-r ${lxc_GLOBAL_DEFAULT_RELEASE}"
	echo -e "\t\t\tRelease of the distribution (hardy, jaunty, 5.2, 10.0)"
	exit 0
}

#Initialise defaults
lxc_CACHE_DISTRIB=${lxc_GLOBAL_DEFAULT_DISTRIB}
lxc_CACHE_RELEASE=${lxc_GLOBAL_DEFAULT_RELEASE}
lxc_CACHE_ARCH=${lxc_GLOBAL_DEFAULT_ARCH}

OPTIND=2
while getopts "hd:r:a:" option; do
	case "$option" in
        	d) lxc_CACHE_DISTRIB="${OPTARG}" ;;
                r) lxc_CACHE_RELEASE="${OPTARG}" ;;
                a) lxc_CACHE_ARCH="${OPTARG}" ;;
                *) localusage ;;
        esac
done

export lxc_CACHE_DISTRIB lxc_CACHE_RELEASE lxc_CACHE_ARCH
lxc_CACHE_CONF="${lxc_GLOBAL_ETC_HOME}/distrib/${lxc_CACHE_DISTRIB}"
source ${lxc_CACHE_CONF} || die "${lxc_CACHE_CONF} does not exists"

f_create() {
	for script in ${lxc_CACHE_ACTIONS}
	do
		echo "Executing ${script}"
		${lxc_GLOBAL_CACHE_HELPERS}/${script} || die "${script} failed"
	done
	 
	#OK commit cache
	mv "${lxc_CACHE_TMPROOTFS}" "${lxc_CACHE_ROOTFS}" || die "mv ${lxc_CACHE_TMPROOTFS} ${lxc_CACHE_ROOTFS} failed"
}

f_list() {
	ls -lah ${lxc_GLOBAL_CACHE_HOME}
}

f_destroy() {
	echo "Not implemented, rm directly from ${lxc_GLOBAL_CACHE_HOME}"
}

f_debuginfo() {
	for var in ${!lxc_*}
	do
		echo -e "${var}=${color_Yellow}${!var}${color_None}"
	done
}

case $1 in
	create) 	f_create ;;
	list)		f_list ;;
	destroy)	f_destroy ;;
	debuginfo)	f_debuginfo ;;	
	*) localusage ;;
esac

exit 0

