#!/bin/bash

export LANGUAGE=""
export LC_ALL=""
export LANG=""

Conf=/lxc/etc/general.conf
. ${Conf}
. ${lxc_PATH_LIBEXEC}/functions.sh

if [[ -z $2 ]]
then
	template=${lxc_DEFAULT_VPS}
else
	template=$2
fi

localusage() {
	myname=$(basename $0)
	echo "Usage:"
	echo "${myname} create rootdistro/distro/release[/specif/../..] [ARCH]: creates template"
	echo "${myname} list : lists available templates"
	echo "${myname} listconf : lists possible templates"
	echo "${myname} destroy rootdistro/distro/release[/specif/../..] ARCH  : deletes template"
	echo "${myname} debuginfo rootdistro/distro/release[/specif/../..] : shows env vars used by scripts"
	exit 0
}

#Load conf
eval "$(${lxc_PATH_LIBEXEC}/cfg_parse.sh ${lxc_PATH_ETC}/templating ${template})" 

#Compose some path
lxc_TMP_ROOTFS="${lxc_PATH_TMP}/templating/${template}/${lxc_ARCH}"
lxc_TEMPLATE_ARCHIVE="${lxc_PATH_TEMPLATE}/$(echo ${template} | sed 's|/|-|g')-${lxc_ARCH}.tgz"
export ${!lxc_*}

f_create() {
	[[ -d "${lxc_TMP_ROOTFS}" ]] && die "${lxc_TMP_ROOTFS} already exists" 
	mkdir -p ${lxc_TMP_ROOTFS} && log "${lxc_TMP_ROOTFS} created"

	#Let's go
	for script in $(${lxc_PATH_LIBEXEC}/get_scripts.pl ${lxc_PATH_SCRIPTS}/templating ${template})
	do
		log "Executing ${script}"
		${script} || die "${script} failed"
	done
	
	#OK commit cache
	log "scripts execution done."
	log "creating archive..."
	[[ -f "${lxc_TEMPLATE_ARCHIVE}" ]] && warning "${lxc_TEMPLATE_ARCHIVE} exists, overwriting..."
	tar czf "${lxc_TEMPLATE_ARCHIVE}" -C "${lxc_TMP_ROOTFS}" . || die "tar cvf ${lxc_TEMPLATE_ARCHIVE} -C "\""${lxc_TMP_ROOTFS}"\"" failed ."
	rm_rf "${lxc_TMP_ROOTFS}"
	log "archive ${lxc_TEMPLATE_ARCHIVE} created."
}

f_list() {
	ls -lah ${lxc_GLOBAL_CACHE_HOME}
}

f_destroy() {
	echo "Not implemented, rm directly from ${lxc_GLOBAL_CACHE_HOME}"
}

f_debuginfo() {
	for var in ${!lxc_*}
	do
		echo -e "${var}=${color_Yellow}${!var}${color_None}"
	done
}

case $1 in
	create) 	f_create ;;
	list)		f_list ;;
	destroy)	f_destroy ;;
	debuginfo)	f_debuginfo ;;	
	*) localusage ;;
esac

exit 0

